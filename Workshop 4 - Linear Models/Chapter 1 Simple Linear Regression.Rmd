---
title: "Linear Regression Workshop"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    css: ../style.css
params:
  date: !r Sys.Date()       
---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(data.table)
library(here)
library(knitr)
library(ggplot2)
library(ggrepel)
library(RplotterPkg)
library(RregressPkg)

current_dir <- here()
```

```{r,setup, include=FALSE, eval=TRUE}
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 12, fig.height = 8)
```

<div>Author: Rick Dean</div>
<div>Article date: `r params$date`</div>

<div class="abstract">
  <p class="abstract">Abstract</p>
  The following are notes and R scripts inspired by [Workshop 4 - Quebec Centre for Biodiversity Science](https://wiki.qcbs.ca/r_workshop4).
</div>

# 1 Overview

## 1.1 Defining mean and Variation
### 1.1.1 Defining mean 
Average value of a population(x): $\bar{x} = 1/n \sum_{i=1}^n x_{i}$

### 1.1.2 Defining variation
Spread around the mean

- mean deviation
- variance
- standard deviation
- coefficient of deviation
  
What is deviation?

- Deviation: $D_{i} = |x_{i} - \bar{x}|$
- Mean deviation: $D = 1/n \sum_{i=1}^n |x_{i} - \bar{x}|$
- Variation (not absolute value, lose meaningful units): $V = 1/n \sum_{i=1}^n (x_{i} - \bar{x})^2$
- Standard variation (root square V, retain units): $\sigma = \sqrt{V}$
- Coefficient of variation (expressed in percentage): $cv = \sigma/\bar{x}$

## 1.2 Linear models
- Y must be continuous
- $\epsilon$: what is not explained by the explanatory variable(s)
 
## 1.3 Linear model assumptions
 1. residuals are independent
 2. residuals are normally distributed
 3. residuals have a mean of 0
 4. residuals are homoskedastic (they have constant variance)
 <div class="note">Note: The assumptions concern the residuals, not the response or explanatory variables</div>
 
## 1.4 Test statistics and p-values 

<blockquote>You could think of the p-value as the probability that the null hypothesis is true, although that's a bit of a simplification. (Technically, the p-value is the probability that, given the assumption that the null hypothesis is true, the test statistic would be the same as or of greater magnitude than the actual observed test statistic.) By convention, we consider that if the p value is less than 0.05 (5%), then we reject the null hypothesis. This cut-off value is called $\alpha$ (alpha). If we reject the null hypothesis then we say that the alternative hypothesis is supported: there is a significant relationship or a significant difference. Note that we do not “prove” hypotheses, only support or reject them. </blockquote>

## 1.5 Work flow
- Plot the data
- Create a model
- Test the model assumptions
- Adjust the model if assumptions are violated
- Interpret the model results
  
# 2 Simple linear regression
Ordinary least squares(OLS) are the most used method and correponds to the default function (lm) in R

## 2.1 Running a linear model
Perform a linear regression with *birdsdiet* data set.

1. Read *birdsdiet.csv*:
```{r, message = FALSE}
data_path <- file.path(current_dir, "Workshop 4 - Linear Models", "data", "birdsdiet.csv")
bird_dt <- data.table::fread(data_path)
str(bird_dt)
```
2. Plot the data:
```{r}
RplotterPkg::create_scatter_plot(
  df = bird_dt,
  aes_x = "Mass",
  aes_y = "MaxAbund",
  title = "Bird Body Size vs Highest Abundance",
  subtitle = "Observed abundance at any site in North America",
  x_title = "Mass(in grams)",
  y_title = "Highest Count",
  show_minor_grids = F,
  x_limits = c(0, 5500),
  x_major_breaks = seq(0,5500,500),
  rot_y_tic_label = T
)
```
3. Run the linear model:
```{r}
abund_mass_lm <- lm(MaxAbund ~ Mass, data = bird_dt)
```

## 2.2 Verifying assumptions

1. Plot the fitted linear model over the observed data:
```{r}
RregressPkg::plot_fit(
  indep = abund_mass_lm$model$Mass,
  dep = abund_mass_lm$model$MaxAbund,
  fit_list = list(MaxAbund = abund_mass_lm$fitted.values),
  title = "Bird Body Size vs Highest Abundance",
  subtitle = "Fitted Linear Model",
  x_title = "Mass(in grams)",
  y_title = "Highest Count",
  show_minor_grids = F,
  x_limits = c(0, 5500),
  x_major_breaks = seq(0,5500,500),
  rot_y_tic_label = T
)
```

### 2.2.1 Verifying residual variance is constant and residual mean is 0

1. Complete a Residual vs Fitted plot: 
```{r}
RregressPkg::plot_fit_residuals(
  model_object = abund_mass_lm,
  title = "Bird Body Size vs Highest Abundance",
  subtitle = "Residual vs Fitted Linear Model",
  x_title = "Fitted Abundance Values",
  y_title = "Model Residuals",
  show_minor_grids = F,
  rot_y_tic_label = T
)
```

2. Complete Scale-location plot:
```{r}
RregressPkg::plot_fit_residuals(
  model_object = abund_mass_lm,
  title = "Bird Body Size vs Highest Abundance",
  subtitle = "Standardized Residual vs Fitted Abundance Values",
  x_title = "Fitted Abundance Values",
  y_title = "sqrt(Standardized Residuals)",
  show_minor_grids = F,
  rot_y_tic_label = T,
  standardized_resid = T,
  y_limits = c(0, 2.5),
  y_major_breaks = seq(0, 2.5, .5)
)
```

<blockquote>...the diagnostic plots enables one to verify whether the residual spread increases with a given fitted values (i.e. identifies whether the spread in the residuals is due to the selected explanatory variable). If the spread increases, the homoscedasticity assumption is not respected. </blockquote>

### 2.2.2 Verifying that residuals are normally distributed
Complete a QQplot of the standardized residuals:
```{r}
RregressPkg::plot_qq(
  obs = abund_mass_lm$residuals,
  standardize = T,
  title = "Normal Q-Q for Standardized Residuals",
  subtitle = "Linear model of Bird Body Size vs Highest Abundance",
  x_title = "Theoretical Quantiles",
  y_title = "Standardized Residuals",
  rot_y_tic_label = T
)
```

<blockquote>The points of the QQplot are nonlinear, which suggests that the residuals are not normally distributed.</blockquote>

### 2.2.3 Checking for high leverage
```{r}
# residual_leverage_lst <- RregressPkg::plot_residual_leverage(
#   fit_formula = abund_mass_lm,
#   residual_gt = 4.0,
#   leverage_gt = 0.4,
#   title = "Standardized Residuals vs Leverage",
# )
# residual_leverage_lst$leverage_plot
```

